# NLM调制策略总结

## 概述
已将级联H桥系统的调制策略统一为**最近电平调制（Nearest Level Modulation, NLM）**，移除了PS-PWM和SHE-PWM等其他调制方法。

## 修改内容

### 1. 核心文件修改
- **`h_bridge_model.py`**：
  - 默认调制策略改为NLM
  - 移除了SHE-PWM相关代码（`calculate_she_angles`, `generate_she_waveform`等）
  - 移除了PS-PWM相关代码（`_generate_output_ps_pwm`等）
  - 移除了不再使用的`scipy.optimize.fsolve`导入
  - 强制使用NLM调制策略

### 2. 系统配置
- **模块数**: 40个
- **每模块直流电压**: 875V
- **总输出电压**: 35kV
- **开关频率**: 1000Hz
- **电网频率**: 50Hz

## NLM调制原理

### 算法思路
```
目标电压: v_ref = m * sin(ωt)
最近电平: L = round(N * m * sin(ωt)) ∈ [-N, N]

每个时刻:
- 如果 L > 0: 前L个模块输出 +Vdc
- 如果 L < 0: 前|L|个模块输出 -Vdc  
- 其余模块输出 0V
```

### 优势
1. **实现简单**: 无需复杂的载波比较或开关角计算
2. **开关损耗低**: 每个模块在每个时刻最多只有一次开关
3. **THD性能优秀**: 在40模块级联下，THD < 2%
4. **电压等级丰富**: 最多可产生81个电压等级（2×40+1）

## 性能测试结果

### THD性能（满足THD < 5%要求）
| 调制比 | THD (%) | RMS电压 (kV) | 峰值电压 (kV) | 输出电平数 |
|--------|---------|--------------|---------------|------------|
| 0.6    | 2.177   | 14.863       | 21.000        | 49         |
| 0.7    | 2.006   | 17.337       | 24.500        | 57         |
| 0.8    | 1.885   | 19.811       | 28.000        | 65         |
| 0.9    | 1.798   | 22.284       | 31.500        | 73         |

### 关键指标
- **最佳THD**: 1.798%（调制比0.9）
- **电压分辨率**: 875V（每模块直流电压）
- **最大调制比**: 1.0
- **理论最大电平数**: 81

## 代码结构

### 主要类和方法
```python
class CascadedHBridgeSystem:
    def __init__(self, N_modules=40, Vdc_per_module=875, fsw=1000, f_grid=50):
        # 强制使用NLM调制策略
        self.modulation_strategy = "NLM"
    
    def generate_phase_shifted_pwm(self, t, modulation_index, phase_shift=0):
        # 直接调用NLM方法
        return self._generate_output_nlm(t, modulation_index)
    
    def _generate_output_nlm(self, t, modulation_index):
        # NLM调制核心实现
        # 返回总输出电压和各个模块电压
```

### 测试脚本
- **`test_nlm_only.py`**: 专门测试NLM调制性能的脚本
- 包含THD计算、波形分析、性能报告等功能

## 使用说明

### 基本使用
```python
from h_bridge_model import CascadedHBridgeSystem

# 创建系统（自动使用NLM）
system = CascadedHBridgeSystem(
    N_modules=40,
    Vdc_per_module=875,
    fsw=1000,
    f_grid=50
)

# 生成输出电压
t = np.linspace(0, 0.02, 1000)  # 一个工频周期
V_total, V_modules = system.generate_phase_shifted_pwm(t, 0.8)

# 计算THD
thd = system.calculate_thd_time_domain(V_total, t) * 100.0
```

### 运行测试
```bash
python test_nlm_only.py
```

## 技术特点

### 1. 电压质量
- **低THD**: 在所有调制比下都小于5%，满足电力系统要求
- **高分辨率**: 81个电压等级，提供平滑的输出波形
- **对称性**: 正负电压对称，无直流偏置

### 2. 效率特性
- **低开关损耗**: 每个模块在每个周期最多开关一次
- **高导通效率**: 减少不必要的开关操作
- **热管理友好**: 降低器件温度，延长寿命

### 3. 控制特性
- **响应快速**: 无需等待载波周期，直接响应参考信号
- **稳定性好**: 算法简单，不易出现数值问题
- **可扩展性**: 模块数量增加时性能线性提升

## 应用场景

### 适用场景
1. **高压大功率**: 35kV及以上电压等级
2. **级联拓扑**: 多模块串联结构
3. **电网接入**: 需要低THD的并网应用
4. **储能系统**: 需要高效率的储能变流器

### 不适用场景
1. **低电压等级**: 模块数少于10个时THD可能较高
2. **高频应用**: 开关频率要求极高的场合
3. **复杂调制**: 需要特殊谐波消除的应用

## 未来优化方向

### 1. 算法优化
- 优化模块选择策略，减少开关次数
- 实现自适应调制比调整
- 添加死区时间补偿

### 2. 性能提升
- 实现多电平空间矢量调制（SVPWM）
- 添加谐波注入技术
- 优化开关时序

### 3. 控制集成
- 与VSG控制策略集成
- 实现动态调制比调整
- 添加故障检测和保护

## 总结

NLM调制策略为35kV级联储能PCS系统提供了优秀的性能表现：

✅ **THD性能**: 所有调制比下都小于5%，满足电力系统要求  
✅ **实现简单**: 算法简洁，易于实现和维护  
✅ **效率优秀**: 低开关损耗，高系统效率  
✅ **扩展性好**: 模块数量增加时性能线性提升  

该策略已成功集成到系统中，可以作为主要的调制方法使用。

